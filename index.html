<!DOCTYPE html>
<html lang="en" manifest="offline.appcache">
<head>
<meta charset=utf-8>
<meta name="viewport" content="width=620">
<title>Offline First Web</title>
<link rel="stylesheet" href="css/html5demos.css">
<script src="js/h5utils.js"></script>
<script type = "text/javascript" src="js/localstoragedb.js"></script>
<script type = "text/javascript" src="js/require.js"></script>
 <script type="text/javascript" src="js/jquery.min.js"></script>
  <script type="text/javascript" src="js/parse-1.3.5.min.js"></script>
  <script type = "text/javascript" src="js/easy-web-worker.js"></script>

<style type="text/css">
#tblPeople tr {
   border: 1px solid black;
}
</style>

</head>

<body>
<section id="wrapper">
    <header style="text-align:center">
      <h1>Offline First! Web</h1>
    </header>

	


<article style="text-align:center">
  <p >Current network status: <span id="status">checking...</span>
  </p>
  <ol id="state"></ol>
</article>

<table>
	<tr>
	<td>
	 	Name
	</td>
	<td>
		Age
	</td>
	<td>
		Gender
	</td>
	<td>
	</td>
	</tr>
	<tr>
	<td>
		<input type ="text" id = "name"/>
	</td>
	<td>
		<input type ="text" id = "age" />
	</td>
	<td>
		<select id = "gender">
		    <option value = "male">Male</option>
		    <option value = "female">Female</option>
		</select>
			
	</td>
	<td>
		<input type ="submit" value = "Save" onclick = "save()" id ="save"/>
	</td>
	</tr>

	</table>


	<br/>

	<br/>
	<b>Awaiting Sync: </b> 	<button onclick = "sync()">Sync</button>
	<br/>

	<table id = "tblPeople">
	</table>

	<br/>
	<br/>

	<button onclick="alert(isOnline())">Check Connectivity</button>

<script> 


  var statusElem = document.getElementById('status');
  var isonLine = ''; 
  
  setInterval(function () { 
   isOnline();
  }, 250);


  function isOnline() {
	var statusElem = document.getElementById('status'); 
  	$.ajax({url: "http://google.co.uk",
        type: "HEAD",
        timeout:2000,
        statusCode: {
            200: function (response) {
                isonLine = 'YES';
                statusElem.className = 'online'; 
   				statusElem.innerHTML = 'online';
            },
            400: function (response) {
                isonLine = 'NO';
                statusElem.className = 'offline'; 
   				statusElem.innerHTML = 'offline';
            },
            0: function (response) {
                isonLine = 'NO';
                statusElem.className = 'offline'; 
   				statusElem.innerHTML = 'offline';
            }              
        }
 		
 	});

    return isonLine;
  }


function sync() {

	//var worker = new EasyWebWorker("worker.js", this);
	//worker.execute("sync");
	var lib = new localStorageDB("people", localStorage);
	var query = lib.query("people");
	Parse.initialize("kQvDcOoUjfKARLE9vuF59uh2rsyVhEUtrpAqztr6", "0BKWnEbz1z9U3xPGRmoIc5I0PjFaozaBr19jFL4p");

	for (var i = 0; i < query.length; i++) { 
		var Person = Parse.Object.extend("Person");
		var person = new Person();
		person.set("name", query[i].name);
		person.set("age", query[i].age);
		person.set("gender", query[i].gender);

		lib.deleteRows("people", {name: query[i].name});
		lib.commit();

		person.save().then(function(object) {
		  bindTable();
		});

	}


}

function syncCallBack() {
    console.log("I got back here");
}

function bindTable() {
	var lib = new localStorageDB("people", localStorage);
	var query = lib.query("people");
	$('#tblPeople').empty();
	var allRows = "";
	for (var i = 0; i < query.length; i++) { 
	  var tableRow = "<tr><td>" + query[i].name + "</td><td>" + query[i].age + "</td><td>" + query[i].gender + "</td></tr>";
	  allRows += tableRow;
	}

	 $('#tblPeople').append(allRows);
}

function save() {

	var name = document.getElementById('name').value;
	var age = document.getElementById('age').value;
	var gender = document.getElementById('gender').value;

	
	if (isonLine == 'NO') {

		alert('getting here');
		var lib = new localStorageDB("people", localStorage);

		var name = document.getElementById('name').value;
		var age = document.getElementById('age').value;
		var gender = document.getElementById('gender').value;

		//if( lib.isNew() ) {
			lib.createTable("people", ["name", "age", "gender"]);
		//}

		lib.insert("people", {name: name, age: age, gender: gender});
		
		lib.commit();

		var query = lib.query("people");

		
	} else {
		Parse.initialize("kQvDcOoUjfKARLE9vuF59uh2rsyVhEUtrpAqztr6", "0BKWnEbz1z9U3xPGRmoIc5I0PjFaozaBr19jFL4p");
		var Person = Parse.Object.extend("Person");
		var person = new Person();

		person.set("name", name);
		person.set("age", age);
		person.set("gender", gender);

		person.save().then(function(object) {
		  alert("yay! it worked");
		});

	}

	document.getElementById('name').value = "";
	document.getElementById('age').value = "";


	bindTable();
}
 
</script> 


    
</section>
<script src="js/prettify.packed.js"></script>
</body>
</html>