<!DOCTYPE html>
<html manifest="employee.appcache">
<head>
	<script src="js/jquery-2.1.4.min.js"></script>
    <link rel="stylesheet" href="css/materialize.min.css">
	<script>

function checkCookie() {
  if (/(^|;\s?)visited=/.test(document.cookie)) {


  } else {
      var time = 3600 * 148000;
      document.cookie = "visited=true; expires=" +  time + "; max-age=" + time + ";";
      getUsers();
  }
}

function login() {

}

function getUsers() {
        $.ajax({
            type: "GET",
            contentType: "application/json; charset=utf-8",
            url:  "https://hub.kainos.com/api/users.json",
            dataType: "json",
            crossDomain: true,
            success: function(data) {
              storeUsersInDB(data.ms_response.users);
            },
            error: function(data) {
                console.log("error ", data.error);
            }                   
        });
    
}


function searchName() {
    const dbName = "employees";
    var request = indexedDB.open(dbName, 2);

    var searchTerm = $("#txtSearch").val();
    var employeeListItem = $("#employeeListItem");

    employeeListItem.empty();

    request.onerror = function(event) {
      // Handle errors.
    };
    request.onsuccess = function(event) {
      var db = event.target.result;
      var objectStore = db.transaction("users").objectStore("users");

      var index = objectStore.index("name");
      var range = IDBKeyRange.bound(searchTerm, searchTerm + '\uffff');

    index.openCursor(range).onsuccess = function(event) {
      var cursor = event.target.result;
      if (cursor) {
        employeeListItem.append("<a href = 'detail.html?id=" + cursor.value.id + "'><li class='collection-item avatar'><img class = 'circle' src = '" + cursor.value.photo + "' /><span class='title'>" + cursor.value.name + "</span><p>" + cursor.value.title + "</p></li></a>")
        cursor.continue();
      }
    };
    };

}

function getEmployeeDetail(id) {
    $.ajax({
            type: "GET",
            contentType: "application/json; charset=utf-8",
            url:  "https://hub.kainos.com/api/users/" + id + ".json",
            dataType: "json",
            crossDomain: true,
            success: function(data) {
              storeDetailInDB(data.ms_response.user);
            },
            error: function(data) {
                console.log("error ", data.error);
            }
                                 
        });
}

function storeDetailInDB(data) {
    const dbName = "employees";
    request = indexedDB.open(dbName, 2);

    request.onerror = function(event) {
      // Handle errors.
    };
    request.onsuccess = function(event) {
        var db = event.target.result;

        var customerObjectStore = db.transaction("users", "readwrite").objectStore("users");
        customerObjectStore.add(data);

    };
}


function storeUsersInDB(data) {
    
    const dbName = "employees";
    request = indexedDB.open(dbName, 2);

    request.onerror = function(event) {
      // Handle errors.
    };
    request.onupgradeneeded = function(event) {
        var db = event.target.result;

        var objectStore = db.createObjectStore("users", { keyPath: "id" });

        objectStore.createIndex("name", "name", { unique: false });

        objectStore.transaction.oncomplete = function(event) {
            // Store values in the newly created objectStore.
        var customerObjectStore = db.transaction("users", "readwrite").objectStore("users");
          for (var i in data) {
              getEmployeeDetail(data[i].id);
            }
          }
    };
}
	</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Kainos Phonebook</title>

</head>

<body onload = "checkCookie()">
	 <nav class="top-nav">
        <div class="container">
          <div class="nav-wrapper"><a class="page-title">Employee Directory</a></div>
        </div>
      </nav>
      <div className="bar bar-standard bar-header-secondary">
                <input id = "txtSearch" type="search"/>
                <button class="waves-effect waves-light btn" style = "width:100%" id="btnSearch" onclick="searchName()">Search</button>
      </div>
      <div >
         <ul id = "employeeListItem" class="collection">

         </ul>

      </div>

</body>

</html>